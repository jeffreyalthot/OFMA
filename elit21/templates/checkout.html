{% extends "base.html" %}

{% block content %}
<div class="checkout-grid">
  <div class="checkout-form">
    <h2>Checkout sécurisé</h2>
    <p>Complétez vos coordonnées puis confirmez le paiement via PayPal ou carte crédit/débit.</p>
    <div class="badge">Client PayPal: {{ paypal_client_id if paypal_client_id else 'Configurer' }}</div>

    <form id="checkout-form" class="order-form">
      <label for="customer_name">Nom et prénom</label>
      <input id="customer_name" name="customer_name" placeholder="Nom complet du client" required />
      <label for="house_number">N° maison</label>
      <input id="house_number" name="house_number" placeholder="Numéro de maison" required />
      <label for="street">Rue ou avenue</label>
      <input id="street" name="street" placeholder="Rue ou avenue" required />
      <label for="apartment">Appartement (facultatif)</label>
      <input id="apartment" name="apartment" placeholder="Appartement, suite, étage" />
      <label for="city">Ville</label>
      <input id="city" name="city" placeholder="Ville" required />
      <label for="province">Province</label>
      <input id="province" name="province" placeholder="Province ou région" required />
      <label for="country">Pays</label>
      <input id="country" name="country" placeholder="Pays" required />
      <label for="postal_code">Code postal</label>
      <input id="postal_code" name="postal_code" placeholder="Code postal" required />
    </form>

    <div id="checkout-status" class="muted"></div>
    <div id="paypal-button-container" class="paypal-box"></div>
    <div id="card-fields-wrapper" class="paypal-box" hidden>
      <p class="muted">Paiement par carte</p>
      <div class="card-fields-grid">
        <div>
          <label>Numéro de carte</label>
          <div id="card-number" class="card-field"></div>
        </div>
        <div>
          <label>Expiration</label>
          <div id="card-expiry" class="card-field"></div>
        </div>
        <div>
          <label>CVV</label>
          <div id="card-cvv" class="card-field"></div>
        </div>
      </div>
      <button id="card-pay-button" type="button" class="action-button">Payer par carte</button>
    </div>
    {% if not paypal_configured %}
      <p class="flash">Configurez PAYPAL_CLIENT_ID et PAYPAL_CLIENT_SECRET (ou PAYPAL_SECRET_KEY_1) dans .env pour activer le paiement.</p>
    {% endif %}
  </div>

  <div class="checkout-summary">
    <h3>Facture client</h3>
    <ul>
      {% for item in items %}
        <li>
          {{ item.product['name'] }} x{{ item.quantity }}
          <span>€ {{ '%.2f'|format(item.line_total) }}</span>
        </li>
      {% endfor %}
    </ul>
    <div class="summary-row">
      <span>Sous-total</span>
      <span>€ {{ '%.2f'|format(subtotal) }}</span>
    </div>
    <div class="summary-row">
      <span>Livraison</span>
      <span>€ {{ '%.2f'|format(shipping_fee) }}</span>
    </div>
    <div class="summary-row total">
      <span>Total TTC</span>
      <span>€ {{ '%.2f'|format(total) }}</span>
    </div>
  </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&components=buttons,card-fields&currency=EUR&intent=capture"></script>
<script>
  (function() {
    const statusEl = document.getElementById('checkout-status');
    const form = document.getElementById('checkout-form');
    const paypalContainer = document.getElementById('paypal-button-container');
    const cardWrapper = document.getElementById('card-fields-wrapper');
    const cardPayButton = document.getElementById('card-pay-button');
    let pendingLocalOrderId = null;

    function setStatus(message, isError) {
      statusEl.textContent = message || '';
      statusEl.className = isError ? 'flash' : 'muted';
    }

    function formDataAsJson() {
      const values = {};
      for (const field of form.elements) {
        if (field.name) values[field.name] = field.value;
      }
      return values;
    }

    function createServerOrder() {
      const payload = formDataAsJson();
      if (!form.reportValidity()) {
        setStatus('Merci de compléter les informations de livraison.', true);
        return Promise.reject(new Error('invalid-form'));
      }
      setStatus('Création de la commande PayPal en cours...', false);
      return fetch("{{ url_for('create_paypal_order') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
          if (!ok || !data.id) {
            setStatus(data.error || 'Erreur lors de la préparation du paiement.', true);
            throw new Error('create-order-failed');
          }
          pendingLocalOrderId = data.local_order_id;
          window.localStorage.setItem('elit21_checkout_order_id', data.local_order_id);
          return data.id;
        });
    }

    function captureServerOrder(paypalOrderId) {
      const localOrderId = pendingLocalOrderId || window.localStorage.getItem('elit21_checkout_order_id');
      setStatus('Validation du paiement...', false);
      return fetch("{{ url_for('capture_paypal_order') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paypal_order_id: paypalOrderId,
          local_order_id: localOrderId
        })
      })
        .then((response) => response.json().then((payload) => ({ ok: response.ok, payload })))
        .then(({ ok, payload }) => {
          if (!ok || !payload.ok) {
            setStatus(payload.error || 'Paiement non confirmé.', true);
            throw new Error('capture-failed');
          }
          pendingLocalOrderId = null;
          window.localStorage.removeItem('elit21_checkout_order_id');
          window.location.href = payload.redirect_url;
        });
    }

    if (window.paypal && {{ 'true' if paypal_configured else 'false' }}) {
      paypal.Buttons({
        style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'paypal' },
        createOrder: createServerOrder,
        onApprove: function(data) {
          return captureServerOrder(data.orderID);
        },
        onError: function(err) {
          if (err && err.message === 'invalid-form') {
            return;
          }
          setStatus('Une erreur est survenue avec PayPal. Réessayez.', true);
        }
      }).render(paypalContainer);

      if (paypal.CardFields) {
        const cardFields = paypal.CardFields({
          createOrder: createServerOrder,
          onApprove: function(data) {
            return captureServerOrder(data.orderID);
          },
          onError: function(err) {
            if (err && err.message === 'invalid-form') {
              return;
            }
            setStatus('Une erreur est survenue avec la carte. Réessayez.', true);
          }
        });

        if (cardFields.isEligible()) {
          cardWrapper.hidden = false;
          cardFields.NumberField().render('#card-number');
          cardFields.ExpiryField().render('#card-expiry');
          cardFields.CVVField().render('#card-cvv');
          cardPayButton.addEventListener('click', function() {
            setStatus('Validation du paiement carte...', false);
            cardFields.submit().catch(function(err) {
              if (err && err.message !== 'invalid-form') {
                setStatus('Paiement carte refusé. Vérifiez les informations saisies.', true);
              }
            });
          });
        }
      }
    } else {
      setStatus('Le paiement PayPal est momentanément indisponible.', true);
    }
  })();
</script>

<style>
  .card-fields-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
    margin: 0.75rem 0;
  }

  .card-field {
    border: 1px solid #d5d9de;
    border-radius: 8px;
    min-height: 44px;
    padding: 0.65rem 0.75rem;
    background: #fff;
  }

  .action-button {
    border: none;
    border-radius: 999px;
    padding: 0.7rem 1.2rem;
    font-weight: 600;
    cursor: pointer;
    color: #fff;
    background: linear-gradient(120deg, #0a56e8, #54b3ff);
  }
</style>
{% endblock %}
