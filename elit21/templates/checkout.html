{% extends "base.html" %}

{% block content %}
<div class="checkout-grid">
  <div class="checkout-form">
    <h2>Checkout sécurisé</h2>
    <p>Complétez vos coordonnées puis confirmez le paiement via PayPal.</p>
    <div class="badge">Client PayPal: {{ paypal_client_id if paypal_client_id else 'Configurer' }}</div>

    <form id="checkout-form" class="order-form">
      <label for="customer_name">Nom et prénom</label>
      <input id="customer_name" name="customer_name" placeholder="Nom complet du client" required />
      <label for="house_number">N° maison</label>
      <input id="house_number" name="house_number" placeholder="Numéro de maison" required />
      <label for="street">Rue ou avenue</label>
      <input id="street" name="street" placeholder="Rue ou avenue" required />
      <label for="apartment">Appartement (facultatif)</label>
      <input id="apartment" name="apartment" placeholder="Appartement, suite, étage" />
      <label for="city">Ville</label>
      <input id="city" name="city" placeholder="Ville" required />
      <label for="province">Province</label>
      <input id="province" name="province" placeholder="Province ou région" required />
      <label for="country">Pays</label>
      <input id="country" name="country" placeholder="Pays" required />
      <label for="postal_code">Code postal</label>
      <input id="postal_code" name="postal_code" placeholder="Code postal" required />
    </form>

    <div id="checkout-status" class="muted"></div>
    <div id="paypal-button-container" class="paypal-box"></div>
    {% if not paypal_configured %}
      <p class="flash">Configurez PAYPAL_CLIENT_ID et PAYPAL_CLIENT_SECRET pour activer le paiement.</p>
    {% endif %}
  </div>

  <div class="checkout-summary">
    <h3>Facture client</h3>
    <ul>
      {% for item in items %}
        <li>
          {{ item.product['name'] }} x{{ item.quantity }}
          <span>€ {{ '%.2f'|format(item.line_total) }}</span>
        </li>
      {% endfor %}
    </ul>
    <div class="summary-row">
      <span>Sous-total</span>
      <span>€ {{ '%.2f'|format(subtotal) }}</span>
    </div>
    <div class="summary-row">
      <span>Livraison</span>
      <span>€ {{ '%.2f'|format(shipping_fee) }}</span>
    </div>
    <div class="summary-row total">
      <span>Total TTC</span>
      <span>€ {{ '%.2f'|format(total) }}</span>
    </div>
  </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=EUR&intent=capture"></script>
<script>
  (function() {
    const statusEl = document.getElementById('checkout-status');
    const form = document.getElementById('checkout-form');
    const paypalContainer = document.getElementById('paypal-button-container');

    function setStatus(message, isError) {
      statusEl.textContent = message || '';
      statusEl.className = isError ? 'flash' : 'muted';
    }

    function formDataAsJson() {
      const values = {};
      for (const field of form.elements) {
        if (field.name) values[field.name] = field.value;
      }
      return values;
    }

    if (window.paypal && {{ 'true' if paypal_configured else 'false' }}) {
      paypal.Buttons({
        style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'paypal' },
        createOrder: function() {
          const payload = formDataAsJson();
          if (!form.reportValidity()) {
            setStatus('Merci de compléter les informations de livraison.', true);
            return Promise.reject(new Error('invalid-form'));
          }
          setStatus('Création de la commande PayPal en cours...', false);
          return fetch("{{ url_for('create_paypal_order') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
            .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
              if (!ok || !data.id) {
                setStatus(data.error || 'Erreur lors de la préparation du paiement.', true);
                throw new Error('create-order-failed');
              }
              window.localStorage.setItem('elit21_checkout_order_id', data.local_order_id);
              return data.id;
            });
        },
        onApprove: function(data) {
          const localOrderId = window.localStorage.getItem('elit21_checkout_order_id');
          setStatus('Validation du paiement...', false);
          return fetch("{{ url_for('capture_paypal_order') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paypal_order_id: data.orderID,
              local_order_id: localOrderId
            })
          })
            .then((response) => response.json().then((payload) => ({ ok: response.ok, payload })))
            .then(({ ok, payload }) => {
              if (!ok || !payload.ok) {
                setStatus(payload.error || 'Paiement non confirmé.', true);
                throw new Error('capture-failed');
              }
              window.localStorage.removeItem('elit21_checkout_order_id');
              window.location.href = payload.redirect_url;
            });
        },
        onError: function() {
          setStatus('Une erreur est survenue avec PayPal. Réessayez.', true);
        }
      }).render(paypalContainer);
    } else {
      setStatus('Le paiement PayPal est momentanément indisponible.', true);
    }
  })();
</script>
{% endblock %}
