{% extends "base.html" %}

{% block content %}
<div class="checkout-grid">
  <div class="checkout-form">
    <h2>Checkout sécurisé</h2>
    <p>Complétez vos coordonnées puis confirmez le paiement via PayPal ou carte crédit/débit.</p>
    <form id="checkout-form" class="order-form">
      <label for="customer_name">Nom et prénom</label>
      <input id="customer_name" name="customer_name" placeholder="Nom complet du client" required />
      <label for="house_number">N° maison</label>
      <input id="house_number" name="house_number" placeholder="Numéro de maison" required />
      <label for="street">Rue ou avenue</label>
      <input id="street" name="street" placeholder="Rue ou avenue" required />
      <label for="apartment">Appartement (facultatif)</label>
      <input id="apartment" name="apartment" placeholder="Appartement, suite, étage" />
      <label for="city">Ville</label>
      <input id="city" name="city" placeholder="Ville" required />
      <label for="province">Province</label>
      <input id="province" name="province" placeholder="Province ou région" required />
      <label for="country">Pays</label>
      <input id="country" name="country" placeholder="Pays" required />
      <label for="postal_code">Code postal</label>
      <input id="postal_code" name="postal_code" placeholder="Code postal" required />
    </form>

    <div id="checkout-status" class="muted"></div>
    <div id="paypal-button-container" class="paypal-box"></div>
    <div id="card-fields-wrapper" class="paypal-box" hidden>
      <p class="muted">Paiement par carte</p>
      <div class="card-fields-grid">
        <div>
          <label>Numéro de carte</label>
          <div id="card-number" class="card-field"></div>
        </div>
        <div>
          <label>Expiration</label>
          <div id="card-expiry" class="card-field"></div>
        </div>
        <div>
          <label>CVV</label>
          <div id="card-cvv" class="card-field"></div>
        </div>
      </div>
      <button id="card-pay-button" type="button" class="action-button">Payer par carte</button>
    </div>
    {% if not paypal_configured %}
      <p class="flash">Configurez PAYPAL_CLIENT_ID et PAYPAL_CLIENT_SECRET (ou PAYPAL_SECRET_KEY_1) dans .env pour activer le paiement.</p>
    {% endif %}
  </div>

  <div class="checkout-summary">
    <h3>Facture client</h3>
    <ul>
      {% for item in items %}
        <li>
          {{ item.product['name'] }} x{{ item.quantity }}
          <span>$ (CAD) {{ '%.2f'|format(item.line_total) }}</span>
        </li>
      {% endfor %}
    </ul>
    <div class="summary-row">
      <span>Sous-total</span>
      <span>$ (CAD) {{ '%.2f'|format(subtotal) }}</span>
    </div>
    <div class="summary-row">
      <span>Livraison</span>
      <span>$ (CAD) {{ '%.2f'|format(shipping_fee) }}</span>
    </div>
    <div class="summary-row total">
      <span>Total TTC</span>
      <span>$ (CAD) {{ '%.2f'|format(total) }}</span>
    </div>
  </div>
</div>

<script>
  (function() {
    const statusEl = document.getElementById('checkout-status');
    const form = document.getElementById('checkout-form');
    const paypalContainer = document.getElementById('paypal-button-container');
    const cardWrapper = document.getElementById('card-fields-wrapper');
    const cardPayButton = document.getElementById('card-pay-button');
    let pendingLocalOrderId = null;
    let pendingPaypalOrderId = null;
    let pendingApproveUrl = null;
    let createOrderRequest = null;
    const debugEnabled = {{ 'true' if paypal_debug_enabled else 'false' }} || new URLSearchParams(window.location.search).get('debug_paypal') === '1' || window.localStorage.getItem('elit21_paypal_debug') === '1';

    function debugLog(eventName, details) {
      if (!debugEnabled) return;
      const payload = {
        at: new Date().toISOString(),
        event: eventName,
        details: details || {}
      };
      window.__paypalDebugLog = window.__paypalDebugLog || [];
      window.__paypalDebugLog.push(payload);
      console.debug('[ELIT21][PayPal]', eventName, payload.details);
    }

    if (debugEnabled) {
      window.localStorage.setItem('elit21_paypal_debug', '1');
      debugLog('debug-mode-enabled', { href: window.location.href });
      window.addEventListener('error', function(evt) {
        const target = evt && evt.target;
        const isScriptError = target && target.tagName === 'SCRIPT';
        debugLog('window.error', {
          message: evt && evt.message ? evt.message : 'unknown',
          source: evt && evt.filename ? evt.filename : null,
          line: evt && evt.lineno ? evt.lineno : null,
          col: evt && evt.colno ? evt.colno : null,
          stack: evt && evt.error && evt.error.stack ? String(evt.error.stack) : null,
          scriptSrc: isScriptError && target && target.src ? target.src : null
        });
      }, true);
      window.addEventListener('unhandledrejection', function(evt) {
        debugLog('window.unhandledrejection', {
          reason: evt && evt.reason ? String(evt.reason.message || evt.reason) : 'unknown'
        });
      });
      document.addEventListener('visibilitychange', function() {
        debugLog('document.visibilitychange', { visibilityState: document.visibilityState });
      });
      window.addEventListener('focus', function() {
        debugLog('window.focus', {});
      });
      window.addEventListener('blur', function() {
        debugLog('window.blur', {});
      });
    }

    function setStatus(message, isError) {
      statusEl.textContent = message || '';
      statusEl.className = isError ? 'flash' : 'muted';
      debugLog('status-updated', { message: message || '', isError: !!isError });
    }

    function formDataAsJson() {
      const values = {};
      for (const field of form.elements) {
        if (field.name) values[field.name] = field.value;
      }
      return values;
    }

    function createServerOrder() {
      if (createOrderRequest) {
        debugLog('create-server-order:reuse-pending-request', {});
        return createOrderRequest;
      }
      if (!form.reportValidity()) {
        setStatus('Merci de compléter les informations de livraison.', true);
        return Promise.reject(new Error('invalid-form'));
      }
      const payload = formDataAsJson();
      debugLog('create-server-order:start', { shipping_city: payload.city, shipping_country: payload.country });
      setStatus('Création de la commande PayPal en cours...', false);
      createOrderRequest = fetch("{{ url_for('create_paypal_order') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
          debugLog('create-server-order:response', { ok: ok, has_order_id: !!data.id, local_order_id: data.local_order_id, error: data.error || null });
          if (!ok || !data.id) {
            setStatus(data.error || 'Erreur lors de la préparation du paiement.', true);
            throw new Error('create-order-failed');
          }
          pendingLocalOrderId = data.local_order_id;
          pendingPaypalOrderId = data.id;
          pendingApproveUrl = data.approve_url || null;
          debugLog('create-server-order:success', { pendingLocalOrderId, pendingPaypalOrderId, has_approve_url: !!pendingApproveUrl });
          window.localStorage.setItem('elit21_checkout_order_id', data.local_order_id);
          return pendingPaypalOrderId;
        })
        .finally(() => {
          createOrderRequest = null;
        });
      return createOrderRequest;
    }

    function isPopupFailure(err) {
      const message = ((err && err.message) || '').toLowerCase();
      return message.includes('popup') || message.includes('window') || message.includes('zoid');
    }

    function logPopupContext(originEvent, details) {
      debugLog(originEvent, Object.assign({
        hasPendingApproveUrl: !!pendingApproveUrl,
        hasPendingLocalOrderId: !!pendingLocalOrderId,
        visibilityState: document.visibilityState,
        hasFocus: document.hasFocus(),
        userActivationActive: !!(navigator.userActivation && navigator.userActivation.isActive),
        userActivationHasBeenActive: !!(navigator.userActivation && navigator.userActivation.hasBeenActive)
      }, details || {}));
    }

    function captureServerOrder(paypalOrderId) {
      const localOrderId = pendingLocalOrderId || window.localStorage.getItem('elit21_checkout_order_id');
      debugLog('capture-server-order:start', { paypalOrderId, localOrderId });
      setStatus('Validation du paiement...', false);
      return fetch("{{ url_for('capture_paypal_order') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paypal_order_id: paypalOrderId,
          local_order_id: localOrderId
        })
      })
        .then((response) => response.json().then((payload) => ({ ok: response.ok, payload })))
        .then(({ ok, payload }) => {
          debugLog('capture-server-order:response', { ok: ok, payload_ok: payload.ok, error: payload.error || null, redirect_url: payload.redirect_url || null });
          if (!ok || !payload.ok) {
            setStatus(payload.error || 'Paiement non confirmé.', true);
            throw new Error('capture-failed');
          }
          pendingLocalOrderId = null;
          pendingPaypalOrderId = null;
          window.localStorage.removeItem('elit21_checkout_order_id');
          debugLog('capture-server-order:success', { redirect_url: payload.redirect_url });
          window.location.href = payload.redirect_url;
        });
    }

    function loadPayPalSdk() {
      if (window.paypal) {
        debugLog('paypal-sdk:already-loaded', {});
        return Promise.resolve(window.paypal);
      }
      if (!{{ 'true' if paypal_configured else 'false' }}) {
        return Promise.reject(new Error('paypal-not-configured'));
      }
      const sdkScript = document.createElement('script');
      const sdkUrl = new URL('https://www.paypal.com/sdk/js');
      sdkUrl.searchParams.set('client-id', '{{ paypal_client_id }}');
      sdkUrl.searchParams.set('components', 'buttons,card-fields');
      sdkUrl.searchParams.set('currency', 'CAD');
      sdkUrl.searchParams.set('intent', 'capture');
      if (debugEnabled) {
        sdkUrl.searchParams.set('debug', 'true');
      }
      sdkScript.src = sdkUrl.toString();
      sdkScript.setAttribute('data-sdk-integration-source', 'button-factory');
      sdkScript.async = true;
      debugLog('paypal-sdk:loading', { src: sdkScript.src });
      return new Promise(function(resolve, reject) {
        sdkScript.onload = function() {
          debugLog('paypal-sdk:loaded', { has_paypal: !!window.paypal });
          resolve(window.paypal);
        };
        sdkScript.onerror = function() {
          debugLog('paypal-sdk:error', {});
          reject(new Error('paypal-sdk-load-error'));
        };
        document.head.appendChild(sdkScript);
      });
    }

    function renderPayPalButtons(paypalSdk) {
      if (!paypalSdk || !paypalSdk.Buttons) {
        debugLog('paypal-buttons:init-failed', {
          reason: 'paypal sdk unavailable',
          hasPayPalObject: !!paypalSdk
        });
        setStatus('Impossible d’initialiser PayPal. Réessayez dans quelques instants.', true);
        return;
      }

      const buttons = paypalSdk.Buttons({
        style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'paypal' },
        onClick: function(data, actions) {
          logPopupContext('paypal-buttons:onClick', {
            fundingSource: data && data.fundingSource,
            buttonVisible: !!(paypalContainer && paypalContainer.offsetParent)
          });
          if (!form.reportValidity()) {
            setStatus('Merci de compléter les informations de livraison.', true);
            return actions.reject();
          }
          debugLog('paypal-buttons:onClick:validated', {});
          return actions.resolve();
        },
        createOrder: function() {
          if (pendingPaypalOrderId) {
            debugLog('paypal-buttons:createOrder:reuse-pending-order', { pendingPaypalOrderId });
            return Promise.resolve(pendingPaypalOrderId);
          }
          return createServerOrder();
        },
        onApprove: function(data) {
          debugLog('paypal-buttons:onApprove', { orderID: data && data.orderID });
          return captureServerOrder(data.orderID);
        },
        onCancel: function() {
          pendingPaypalOrderId = null;
          debugLog('paypal-buttons:onCancel', {});
          setStatus('Paiement annulé. Vous pouvez réessayer.', true);
        },
        onError: function(err) {
          logPopupContext('paypal-buttons:onError', {
            message: err && err.message ? err.message : String(err),
            stack: err && err.stack ? String(err.stack) : null,
            isPopupFailure: isPopupFailure(err)
          });
          if (err && err.message === 'invalid-form') {
            return;
          }
          if (isPopupFailure(err) && pendingApproveUrl) {
            pendingPaypalOrderId = null;
            setStatus('Le popup PayPal a été bloqué. Redirection vers PayPal en cours...', true);
            debugLog('paypal-buttons:popup-fallback-redirect', { pendingApproveUrl });
            window.location.href = pendingApproveUrl;
            return;
          }
          if (isPopupFailure(err) && !pendingApproveUrl) {
            setStatus('Le popup PayPal a été bloqué. Préparation d’une redirection sécurisée...', true);
            debugLog('paypal-buttons:popup-fallback-create-order', {});
            createServerOrder()
              .then(function() {
                if (!pendingApproveUrl) {
                  throw new Error('missing-approve-url');
                }
                pendingPaypalOrderId = null;
                debugLog('paypal-buttons:popup-fallback-redirect-after-create', { pendingApproveUrl });
                window.location.href = pendingApproveUrl;
              })
              .catch(function(fallbackError) {
                debugLog('paypal-buttons:popup-fallback-failed', { message: fallbackError && fallbackError.message ? fallbackError.message : String(fallbackError) });
                setStatus('Impossible d’ouvrir PayPal automatiquement. Réessayez.', true);
              });
            return;
          }
          if (debugEnabled && err) {
            setStatus('Erreur PayPal: ' + (err.message || String(err)), true);
            return;
          }
          setStatus('Une erreur est survenue avec PayPal. Réessayez.', true);
        }
      });

      if (!buttons) {
        debugLog('paypal-buttons:init-failed', { reason: 'paypal.Buttons returned falsy value' });
        setStatus('Impossible d’initialiser le bouton PayPal.', true);
        return;
      }

      buttons.render(paypalContainer)
        .then(function() {
          debugLog('paypal-buttons:rendered', { containerPresent: !!paypalContainer });
        })
        .catch(function(err) {
          logPopupContext('paypal-buttons:render-error', {
            message: err && err.message ? err.message : String(err),
            stack: err && err.stack ? String(err.stack) : null
          });
          setStatus('Impossible d’afficher le bouton PayPal. Réessayez.', true);
        });

      if (paypalSdk.CardFields) {
        const cardFields = paypalSdk.CardFields({
          createOrder: createServerOrder,
          onApprove: function(data) {
            debugLog('paypal-card:onApprove', { orderID: data && data.orderID });
            return captureServerOrder(data.orderID);
          },
          onError: function(err) {
            debugLog('paypal-card:onError', { message: err && err.message ? err.message : String(err) });
            if (err && err.message === 'invalid-form') {
              return;
            }
            setStatus('Une erreur est survenue avec la carte. Réessayez.', true);
          }
        });

        if (cardFields.isEligible()) {
          debugLog('paypal-card:is-eligible', {});
          cardWrapper.hidden = false;
          cardFields.NumberField().render('#card-number');
          cardFields.ExpiryField().render('#card-expiry');
          cardFields.CVVField().render('#card-cvv');
          cardPayButton.addEventListener('click', function() {
            if (!form.reportValidity()) {
              setStatus('Merci de compléter les informations de livraison.', true);
              return;
            }
            setStatus('Validation du paiement carte...', false);
            cardFields.submit().catch(function(err) {
              debugLog('paypal-card:submit-error', { message: err && err.message ? err.message : String(err) });
              if (err && err.message !== 'invalid-form') {
                setStatus('Paiement carte refusé. Vérifiez les informations saisies.', true);
              }
            });
          });
        } else {
          debugLog('paypal-card:not-eligible', {});
        }
      }
    }

    setStatus('Chargement sécurisé du module PayPal...', false);
    loadPayPalSdk()
      .then(function(paypalSdk) {
        setStatus('', false);
        renderPayPalButtons(paypalSdk);
      })
      .catch(function(error) {
        if (error && error.message === 'paypal-not-configured') {
          setStatus('Le paiement PayPal est momentanément indisponible.', true);
          return;
        }
        setStatus('Impossible de charger le module PayPal. Réessayez dans quelques instants.', true);
      });
  })();
</script>

<style>
  .card-fields-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
    margin: 0.75rem 0;
  }

  .card-field {
    border: 1px solid #d5d9de;
    border-radius: 8px;
    min-height: 44px;
    padding: 0.65rem 0.75rem;
    background: #fff;
  }

  .action-button {
    border: none;
    border-radius: 999px;
    padding: 0.7rem 1.2rem;
    font-weight: 600;
    cursor: pointer;
    color: #fff;
    background: linear-gradient(120deg, #0a56e8, #54b3ff);
  }
</style>
{% endblock %}
