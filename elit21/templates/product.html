{% extends "base.html" %}

{% block content %}
<div class="product-detail">
  <div>
    <h2>{{ product['name'] }}</h2>
    <p>{{ product['description'] }}</p>
    <div class="price">$ (CAD) {{ '%.2f'|format(product['price']) }}</div>
    <p><strong>Stock:</strong> {{ product['stock'] }}</p>
    <div class="product-options">
      <label for="color"><strong>Couleur</strong></label>
      <select id="color" name="color" form="add-to-cart">
        <option value="">--</option>
        {% for color in colors %}
          <option value="{{ color }}">{{ color }}</option>
        {% endfor %}
      </select>

      <label for="size"><strong>Taille</strong></label>
      <select id="size" name="size" form="add-to-cart">
        <option value="">--</option>
        {% for size in sizes %}
          <option value="{{ size }}">{{ size }}</option>
        {% endfor %}
      </select>

      <label for="category"><strong>Catégorie</strong></label>
      <select id="category" name="category" form="add-to-cart">
        <option value="">--</option>
        {% if product['category'] %}
          <option value="{{ product['category'] }}" selected>{{ product['category'] }}</option>
        {% endif %}
      </select>
    </div>
    <p class="badge">Paiement sécurisé via PayPal</p>
    <form id="add-to-cart" class="cart-add" method="post" action="{{ url_for('add_to_cart', product_id=product['id']) }}">
      <button type="submit">Ajouter au panier</button>
    </form>
    <button class="text-button" type="button" onclick="history.back()">Retour</button>
    {% if inventory %}
      <div class="inventory-block">
        <h4>Disponibilités par variante</h4>
        <ul>
          {% for row in inventory %}
            <li>{{ row['color'] }} / {{ row['size'] }} : {{ row['quantity'] }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
  <div class="product-gallery">
    <div class="product-image-frame">
      {% if images %}
        <img
          id="product-main-image"
          src="{{ url_for('product_image', product_id=product['id'], image_id=images[0]['id']) }}"
          alt="{{ product['name'] }}"
        />
      {% else %}
        <img id="product-main-image" src="https://via.placeholder.com/600x600?text=ELIT21" alt="{{ product['name'] }}" />
      {% endif %}
    </div>
    {% if images|length > 1 %}
      <div class="gallery-controls">
        <button id="gallery-prev" type="button" aria-label="Image précédente">&#8592;</button>
        <button id="gallery-next" type="button" aria-label="Image suivante">&#8594;</button>
      </div>
      <script>
        (() => {
          const images = [
            {% for image in images %}
              "{{ url_for('product_image', product_id=product['id'], image_id=image['id']) }}"{% if not loop.last %},{% endif %}
            {% endfor %}
          ];
          const mainImage = document.getElementById("product-main-image");
          const prevButton = document.getElementById("gallery-prev");
          const nextButton = document.getElementById("gallery-next");

          let current = 0;
          const showImage = (index) => {
            current = (index + images.length) % images.length;
            mainImage.src = images[current];
          };

          prevButton.addEventListener("click", () => showImage(current - 1));
          nextButton.addEventListener("click", () => showImage(current + 1));
        })();
      </script>
    {% endif %}
  </div>
</div>
{% endblock %}
